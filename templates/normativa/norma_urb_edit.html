{% extends 'base_nfr.html' %}
{% load static %}
<!--Css-->
{% block css %}
<link rel="stylesheet" href="{% static 'stylos/css/bootstrap.min.css' %}"/>
{% comment %} <link rel="stylesheet" href="{% static 'stylos/css/sidebar.css' %}"/>
<link href="{% static 'css/css-estilos_das.css' %}" rel="stylesheet">
<link href="{% static 'css/css-paginacion_das.css' %}" rel="stylesheet"> {% endcomment %}
<link href="https://fonts.googleapis.com/css?family=Roboto:400,300,500,700" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!--boostrap icono-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<link href="//cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">
{% endblock %}
<!--content-->
{% block content %}

<div class="mx-2">
<!--   Area Form    -->
<script type="text/javascript">
    function submitByEnter(e) {
        if (e.keyCode == 13) {
            document.getElementById("FormListado:b_RealizaBusqueda").click();
            return false;
        }
        else {
            return true;
        }
    }
</script>
<br>
<div class="row text-center" >
    <div class="col-2">
        <a href="{% url 'home' %}">
            <i class="fa fa-home fa-3x text-warning" aria-hidden="true"></i>
        </a>
    </div>

    <div class="col-8">
        <h1 class="gUppercase gFontWeight700" >
            Reglamento Nacional de Edificaciones
        </h1>
    </div>

    <div class="col-2">
        <a href="{% url 'norma_edificatoria' %}">
            <i class="fa fa-arrow-right fa-3x text-warning" aria-hidden="true"></i>
        </a>
    </div>
</div>
<br><br>

<div class="">
    <div class="row">
      <div class="col-sm" style="height:720px;">
        <div class="form-group">
            <select class="form-control" name="subnormativas[]" multiple="multiple" style="height:100%;" id="select-norms">
                {% for sn in subtipo_normas %}
                    <small>
                        <option class="text-wrap" value="{{sn.id}}">{{sn.subcategory_name}} </option>

                    </small>
                {% endfor %}
            </select>
        </div>
      </div>
      
      <div class="col-sm-9">
        <div class="row mb-3 px-2">
            <select class="form-control" id="area-normas">
                <small>
                    <option class="text-wrap" value="0">TODOS</option>

                </small>
                {% for an in area_normas %}
                    <small>
                        <option class="text-wrap" value="{{an.id}}">{{an.area_name}} </option>

                    </small>
                {% endfor %}

            </select> 
        </div>
        <div class="row">
            <div class="col-md">
                <div class="form-group">
                    <div class="form-control mb-3">
                        <select class="form-control select2" name="palabras_clave[]" multiple="multiple" style="width:100%;height:100%;" id="keywords" >
                            {% for pc in palabras_clave %}
                                <option value="{{pc.id}}"> {{pc.name}} </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md">
                <div class="form-group">
                    <div class="form-control mb-3">
                        <input class="form-control" type="text" id="filter-input" placeholder="BUSCAR POR NORMA, TITULO O BASE LEGAL"/>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <input class="form-control" type="text" name="datetimes" id="datetimes"/>
            </div>
        </div>

        <div class="row">


            {% if norma_date %}
            <table class="table table-bordered datatable" id="normas-tabla">
                <thead class="thead-dark">
                    <tr class="text-center">
                        <th style="width:20%">Norma</th>
                        <th style="width:40%">Titulo</th>
                        <th style="width:20%">Base Legal</th>
                        <th style="width:10%">Tipo Uso</th>
                        <th style="width:7%">Documento</th>
                        <th style="width:13%">Publicacion</th>
                    </tr>
                </thead>
                <tbody id="normas_edificatorias">
                    {% for norma in norma_date %}
                    <tr>
                        <td>
                            {{norma.norma}}
                        </td>
                        <td>{{norma.name_denom}}
                            {% if norma.es_vigente == False %}
                                <span class="fst-italic fw-lighter fs-7 text-center text-danger">*No vigente</span>
                            {% endif %}

                            {% if norma.descripcion %}
                                <p class="mt-3 "> <span class="fw-bold">Descripción:</span><small> {{norma.descripcion}}.</small>  </p>
                            {% endif %}
                        </td>
                        <td>{{norma.base_legal}}</td>
                        <td>{{norma.tipo_uso}}</td>
                        <td class="text-center">
                            {% if norma.document %}
                                <a target="_blank" href="{{norma.document.url}}">
                                    <svg xmlns="http://www.w3.org/2000/svg" style="color:black;position:relative;"width="28" height="28" fill="currentColor" class="bi bi-file-pdf" viewBox="0 0 16 16">
                                        <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                                        <path d="M4.603 12.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.701 19.701 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.187-.012.395-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.065.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.716 5.716 0 0 1-.911-.95 11.642 11.642 0 0 0-1.997.406 11.311 11.311 0 0 1-1.021 1.51c-.29.35-.608.655-.926.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.27.27 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.647 12.647 0 0 1 1.01-.193 11.666 11.666 0 0 1-.51-.858 20.741 20.741 0 0 1-.5 1.05zm2.446.45c.15.162.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.881 3.881 0 0 0-.612-.053zM8.078 5.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
                                    </svg>
                                </a>
                            {% else %}

                            <span class="text-center"><i class="fa fa-minus fa-2x text-dark" aria-hidden="true"></i></span>
                            {% endif %}
                        </td>
                        <td>{{norma.fecha_publi}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                
            </table>
        {% endif %}
              

        </div>
        
      </div>
    </div>
  </div>

  <br>
  <br>
  <div id="demo">
      
  </div>
</div>
   


{% endblock %}

{% block js %}
<script src="//cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>


<script>



    const params = new Proxy(new URLSearchParams(window.location.search), {
    get: (searchParams, prop) => searchParams.get(prop),
    });
    // Get the value of "some_key" in eg "https://example.com/?some_key=some_value"
    var ne = params.ne; // "some_value"

    $('#datetimes').daterangepicker({
        locale: {
            format: 'YYYY-MM-DD'
        }
    });
    
    const normas = {{ normas|safe }}
    var uac = normas;
    var subnormativas = $("#select-norms").val(),
        search = $("#filter-input").val()
        tipo_uso_id = $("#area-normas").val(),
        date_range = undefined
        keywords = $("#keywords").val()
        date_range = undefined;

    var normas_tabla = $('#normas-tabla').DataTable({
        searching: false,
        ordering:  false,
        lengthChange: false,
    })

    //console.log(normas)


    $("#select-norms option").each(function()
    {
        if(ne == $(this).text().substring(0,1))
        {
            subnormativas.push($(this).val())
        }
    });

    $("#select-norms").val(subnormativas)
    execFilters()

    $("#select-norms").change(function(){
        subnormativas = $("#select-norms").val()
        execFilters() 
    });

    $("#filter-input").keyup(function(){
        
        search = $("#filter-input").val() 
        execFilters()  
    })

    $("#area-normas").change(function(){
        
        tipo_uso_id = $("#area-normas").val()
        execFilters()  
    })

    $('#datetimes').change(function(){
        date_range = $('#datetimes').data('daterangepicker')
        execFilters()
    }) 

    $("#keywords").change(function(){
        keywords = $("#keywords").val()
        execFilters()
    })

    function getNormativas(subnormativas)
    {
        if (subnormativas.length != 0) {
            let respuesta = [];
        
            subnormativas.forEach(sn => {
                let r = uac.filter(n => {
                            return n.tipo_norma_id == sn
                        })

                respuesta = respuesta.concat(r)
            })
            return respuesta
        } else {
            return uac
        }

        
    }

    function getSearchNormativas(search)
    {
        if( search != undefined ) {
            return uac.filter(n => {
                return n.norma.toLowerCase().includes(search.toLowerCase()) 
                        || n.name_denom.toLowerCase().includes(search.toLowerCase()) 
                        || n.base_legal.toLowerCase().includes(search.toLowerCase())
            })
        } else {
            return uac
        }

        
    }

    function getTipoUsoNormativas(tipo_uso_id)
    {
        if (tipo_uso_id != 0) {
            return uac.filter(n => {
                return n.tipo_uso_id == tipo_uso_id
            })
        } else {
            return uac
        }
    }

    function getNormasPorFechas(date_range)
    {
        if (date_range != undefined) {

            return uac.filter(n => {
                return moment(n.fecha_publi) >= moment(date_range.startDate.format('YYYY-MM-DD')) && moment(n.fecha_publi) <= moment(date_range.endDate.format('YYYY-MM-DD'))
            })
        } else {
            return uac
        }
    }

    function getNormasPorKeywords(keywords)
    {

        if (keywords.length != 0) {
            let respuesta = [];

            keywords.filter(k => {
                let r = uac.filter(n => {
                            return n.palabras_clave.includes(parseInt(k))
                        })

                respuesta = respuesta.concat(r)
            })

            return respuesta
        } else {
            return uac
        }

        
    }

    function execFilters()
    {
        uac = getNormativas(subnormativas)
        uac = getSearchNormativas(search)
        uac = getTipoUsoNormativas(tipo_uso_id)
        uac = getNormasPorKeywords(keywords)
        uac = getNormasPorFechas(date_range)

        normas_tabla.destroy()

        render(uac)

        normas_tabla = $('#normas-tabla').DataTable({
            searching: false,
            ordering:  false,
            lengthChange: false,
        })
        

        uac = normas
    }
    
    function render(resultado)
    {
        html = ``
    
        resultado.forEach((r) => {
            html += /*html*/
                    `<tr >
                        <td style="width:20%">
                            ${r.norma}`;
                        
            if (r.es_vigente) {
                html += /*html*/`
                    <span class="fst-italic fw-lighter fs-7 text-center text-danger">*No vigente</span>
                `
            }

            html +=/*html*/
                `</td style="width:40%">
                    <td>
                        ${r.name_denom}
                        `
                        
                        if (r.descripcion) {
                            html += /*html*/`
                                <p class="mt-3 "> <span class="fw-bold">Descripción:</span><small> ${r.descripcion}.</small>  </p>
                            `
                        }
                        
                        html +=/*html*/`
                    </td>
                    <td style="width:20%">${r.base_legal}</td>
                    <td style="width:10%">${r.tipo_uso}</td>
                    <td class="text-center" style="width:7%">
                        `
                        
                        if (r.document) {
                            html += /*html*/`
                                <a target="_blank" href="${r.document}">
                                    <i class="fa fa-file-pdf fa-2x text-danger mr-1" aria-hidden="true"></i>
                                </a>

                        
                            `
                        } else {
                            html += /*html*/` <span class="text-center"><i class="fa fa-minus fa-2x text-dark" aria-hidden="true"></i></span>`
                        }

                        if (r.tiene_preguntas) {
                            html += /*html*/`
                                <a target="_blank" href="/preguntas?norma_id=${r.id}">
                                    <i class="fa fa-question fa-2x text-info mr-1" aria-hidden="true"></i>
                                </a>

                        
                            `
                        }
                        
                        html += /*html*/`
                    </td>
                    <td style="width:13%">
                        ${r.fecha_publi}
                    </td>
                </tr>`
        })

        document.getElementById('normas_edificatorias').innerHTML = html;
    }

</script>

{% endblock js %}