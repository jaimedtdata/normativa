{% extends 'base_nfr.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
    
    <div class="container ">
        <div class="row text-center">
            <div class="col-2">
                <a href="{% url 'home' %}">
                    <i class="fa fa-home fa-3x text-warning" aria-hidden="true"></i>
                </a>
            </div>
    
            <div class="col-8">
                <h1 class="gUppercase gFontWeight700">
                    Editar Normativa
                </h1>
            </div>
    
            <div class="col-2">
                <a href="{% url 'index-normativas' %}">
                    <i class="fa fa-arrow-right fa-3x text-warning" aria-hidden="true"></i>
                </a>
            </div>
        </div>
        <br><br>
        <form  id="fileForm" method='POST' enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        {{ form.norma|as_crispy_field }}
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        {{ form.name_denom|as_crispy_field }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        {{ form.base_legal|as_crispy_field }}
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        {{ form.fecha_publi|as_crispy_field }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        <label> Tipo de Uso: </label>
                        <select class="form-control" aria-label="Default select example" name="tipo_uso" id="tipo_uso_id">
                            {% for tipo in tipo_uso %}
                            <option value="{{tipo.id}}">{{tipo.area_name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label> Subtipo de Uso: </label>
                        <select class="form-control" aria-label="Default select example" name="subtipo_uso" id="subtipo_uso_id">
                            {% for subtipo in subtipo_uso %}
                                <option value="{{subtipo.id}}">{{subtipo.name}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="form-group">
                        {{ form.tipo_norma|as_crispy_field }}
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        {{ form.estado|as_crispy_field }}
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-6">
                    <div class="form-group">
                        {{ form.document|as_crispy_field }}
                        {% if normativa.document %}
                            <a class="text-dark" target="_blank" href="{{normativa.document.url}}">
                                <b> Esta Normativa tiene archivo (click para ver) </b>
                            </a>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <div class="w-full bg-gray-100">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                              </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <h3 id="status"></h3>
                    </div>
                    <div class="form-group">
                        {{ form.universo|as_crispy_field }}
                    </div>
                    <div class="form-group">
                        {{ form.articulo|as_crispy_field }}
                    </div>
                    
                    
                </div>
                <div class="col-6 ">
                    <div class="form-group ">
                        {{ form.descripcion|as_crispy_field }}
                    </div>
                    <span id="max_characters" class="text-muted text-italic float-right">0/700</span>
                </div>
            </div>
            <button class="btn btn-lg btn-primary float-right mt-2" type="submit" id="submitBtn" >Guardar Cambios</button>
        </form>
        <h2 class="text-center mt-5"> Editar Palabras Clave</h2>
        {% include '../partials/_palabras_clave.html' %}
        
    </div>
{% endblock %}


{% block js %}
<script>
    
</script>

    <script>

        const max_characters = document.getElementById('max_characters')
        const ld = document.getElementById('id_descripcion')

        ld.addEventListener('keyup', e => {
            max_characters.innerHTML = `${ld.value.length}/700`
        })

        ld.addEventListener('keypress', e => {
            max_characters.innerHTML = `${ld.value.length}/700`
        })

        // FUNCIONES PARA EL LISTADO DINAMICO
        const tipos_uso = document.getElementById('tipo_uso_id')
        const subtipos_uso = document.getElementById('subtipo_uso_id')
        const subtipos_uso_json = {{ subtipos_uso_json|safe }}
        
        
        tipos_uso.value = "{{normativa.subtipo_uso.tipo_uso_id}}" 
        
        changeOptionsSubtipoUso()
        

        subtipos_uso.value = "{{normativa.subtipo_uso_id}}" 

        tipos_uso.addEventListener('change', (e) => {

            changeOptionsSubtipoUso()
            
        })

        function changeOptionsSubtipoUso() {
            var options_sbu = ``
            subtipos_uso_json.forEach( sbu => {
                if( sbu.tipo_uso_id == tipos_uso.value ) {
                    options_sbu += /*html*/`<option class="text-wrap" value="${sbu.id}">${sbu.name}</option>`
                }            
            })

            if (options_sbu.length == 0) {
                options_sbu += /*html*/`<option class="text-wrap" value selected>---SIN SUBTIPOS, SELECCIONE OTRO TIPO DE USO---</option>`
            }

            subtipos_uso.innerHTML = options_sbu
        }

        $(document).ready(function() {

            $('#id_tipo_norma').val('{{normativa.tipo_norma_id}}')    
            $('#id_tipo_uso').val('{{normativa.tipo_uso_id}}')    
            $('#id_es_foro').prop('checked',  '{{normativa.es_foro}}' == 'True' ? true : false )
            $('#id_es_vigente').prop('checked',  '{{normativa.es_vigente}}' == 'True' ? true : false )
            
            $("#registrar_palabras").submit( function(e) {
                e.preventDefault();
                $.ajax({
                    url: $(this).attr('action'),
                    type: $(this).attr('method'),
                    data: $(this).serialize()
                  }).done(function(data) {
                    $('.select-tags').val(null).trigger('change');
                    html = ``
    
                    data.forEach((e) => {
                        html += /*html*/
                                `<tr>
                                    <th scope="row">${e.id}</th>
                                    <td>${e.name}</td>
                                    <td>
                                        <button type="button" onclick="eliminarPc(${e.id})" class="btn btn-block btn-danger">    
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`
                    })
    
                    document.getElementById('normativas_palabras_clave').innerHTML = html;
    
                  });
            })
    
            
            
    
        });
    
        function eliminarPc(id) {
            $.ajax({
                url: `{% url 'eliminar-palabras-clave-normativa' normativa.id %}`,
                data: {
                    'palabra_clave_id' : id
                }
                }).done(function(data) {
    
                html = ``
    
                data.forEach((e) => {
                    html += /*html*/
                            `<tr>
                                <th scope="row">${e.id}</th>
                                <td>${e.name}</td>
                                <td>
                                    <button type="button" onclick="eliminarPc(${e.id})" class="btn btn-block btn-danger">    
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>`
                })
    
                document.getElementById('normativas_palabras_clave').innerHTML = html;
    
                });
        }

        let submitting = false
        let file = null

        function setIsSubmitting(val) {
            submitting = val
        }

        function setFile(val) {
            file = val
        }

        _("id_document").addEventListener("change", event => {
            setFile(event.target.files[0])
        })

        _("submitBtn").addEventListener("click", event => {
            if (file != null ) {
                handleSubmit(event)
                _("submitBtn").disabled = true
                _("submitBtn").innerHTML = /*html*/`<div class="spinner-border spinner-border-sm text-light" role="status">
                                                        <span class="sr-only">Loading...</span>                   
                                                        </div>
                                                    Guardar
                                                    `
            }
        })

        const handleSubmit = async event => {

            setIsSubmitting(true)

            const signedUrl = await getSignedUrl()

            try {
                uploadFile(signedUrl)
            }
            catch (err) {
                setIsSubmitting(false)
                console.log(err)
                alert('There was an error uploading your file.')
                throw err
            }

            setIsSubmitting(false)
        }

        const getSignedUrl = async () => {
            const body = {
                fileName: file.name,
                fileType: file.type,
            }

            const response = await fetch("{% url 'signed-url' %}", {
                method: 'POST',
                body: JSON.stringify(body),
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token }}"}
            })
            const { url } = await response.json()
            return url
        }

        function _(el) {
            return document.getElementById(el);
        }

        function uploadFile(signedUrl) {
            var formdata = new FormData();
            formdata.append("file", file);
            var ajax = new XMLHttpRequest();
            ajax.upload.addEventListener("progress", progressHandler, false);
            ajax.addEventListener("load", completeHandler, false);
            ajax.addEventListener("error", errorHandler, false);
            ajax.addEventListener("abort", abortHandler, false);
            ajax.addEventListener("loadend", loadendHandler, false)
            ajax.open("PUT", signedUrl);
            ajax.setRequestHeader('Content-Type', file.type)
            ajax.setRequestHeader('x-amz-acl', 'public-read')
            ajax.send(formdata);
        }

        async function submitForm() {
            _("fileForm").submit()
            _("submitBtn").disabled = false
        }

        async function loadendHandler(event) {
            await submitForm()
        }

        function progressHandler(event) {
            var percent = Math.round((event.loaded / event.total) * 100);
            _("progressBar").style.width = `${percent}%`;
            _("progressBar").innerText = `${percent}%`;
            _("status").innerHTML = percent + "% Subiendo.. espere un momento";
        }

        function completeHandler(event) {
            _("status").innerHTML = event.target.responseText;
            _("progressBar").style.width = 0;
            _("progressBar").innerText = "0%";
        }

        function errorHandler(event) {
            _("status").innerHTML = "Por favor espere";
        }

        function abortHandler(event) {
            _("status").innerHTML = "Upload Aborted";
        }


    </script>
{% endblock %}